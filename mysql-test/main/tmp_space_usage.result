flush status;
flush global status;
show session status like "max_tmp_space_used";
Variable_name	Value
Max_tmp_space_used	0
show global status like  "max_tmp_space_used";
Variable_name	Value
Max_tmp_space_used	0
#
# MDEV-9101 Limit size of total size of created disk temporary files
#           and tables.
show session status like "tmp_space_used";
Variable_name	Value
Tmp_space_used	0
show global status like "tmp_space_used";
Variable_name	Value
Tmp_space_used	0
select @@global.max_tmp_space_usage, @@global.max_total_tmp_space_usage;
@@global.max_tmp_space_usage	@@global.max_total_tmp_space_usage
524288	786432
select @@binlog_stmt_cache_size,@@binlog_format;
@@binlog_stmt_cache_size	@@binlog_format
32768	ROW
create table t1 (a int primary key, v varchar(256), c int default(0)) engine=innodb;
insert into t1 (a,v) select seq, repeat(char(64+mod(seq,32)),mod(seq,254)+1) from seq_1_to_65536;
ERROR HY000: Local temporary space limit reached
set @@max_tmp_space_usage=1024*1024*1024;
insert into t1 (a,v) select seq, repeat(char(64+mod(seq,32)),mod(seq,254)+1) from seq_1_to_65536;
ERROR HY000: Global temporary space limit reached
set @@max_tmp_space_usage=default;
set @@binlog_format="statement";
insert into t1 (a,v) select seq, repeat(char(64+mod(seq,32)),mod(seq,254)+1) from seq_1_to_65536;
insert into t1 (a,v) select seq, repeat(char(64+mod(seq,32)),mod(seq,254)+1) from seq_65537_to_131072;
select count(*) from t1;
count(*)
131072
create table t2 (a int, b int) engine=innodb select seq as a, 0 as b from seq_1_to_131072;
set @@binlog_format="row";
set @@tmp_memory_table_size=32*1024;
# The following queries should fail because of tmp_space_usage
select * from t1 order by a,v;
ERROR HY000: Local temporary space limit reached
select v,count(*) from t1 group by v limit 2;
ERROR HY000: Local temporary space limit reached
update t1 set v=right(v,2);
ERROR HY000: Local temporary space limit reached
set @@binlog_format="statement";
set @@max_tmp_space_usage=65536;
set @@tmp_memory_table_size=0;
update t1,t2 set t1.c=t2.a, t2.b=1 where t1.a=t2.a;
ERROR HY000: Local temporary space limit reached
set @@binlog_format="row";
set @@max_tmp_space_usage=default;
drop table t1,t2;
#
# Check max_total_tmp_space_usage & processlist
#
set @@tmp_memory_table_size=1024*1024;
show session status like "tmp_space_used";
Variable_name	Value
Tmp_space_used	0
set @@tmp_memory_table_size=0;
flush status;
# session.max_tmp_space_usage == global.max_tmp_space_usage
connect c1, localhost, root,,;
connection default;
create table t1 (a int primary key, v varchar(256), c int default(0)) engine=innodb;
create table t2 (a int primary key, v varchar(256), c int default(0)) engine=innodb;
begin;
insert into t1 (a,v) select seq, repeat(char(64+mod(seq,32)),mod(seq,254)+1) from seq_1_to_3000;
connection c1;
# information_schema.process_list.tmp_space_used == status.tmp_space_used
insert into t2 (a,v) select seq, repeat(char(64+mod(seq,32)),mod(seq,254)+1) from seq_1_to_3000;
ERROR HY000: Global temporary space limit reached
# Test setting tmp_space_usage to 0 to disable quotas
set @save_max_total_tmp_space_usage=@@global.max_total_tmp_space_usage;
set @@global.max_total_tmp_space_usage=0;
set @@max_tmp_space_usage=0;
insert into t2 (a,v) select seq, repeat(char(64+mod(seq,32)),mod(seq,254)+1) from seq_1_to_3000;
set @@global.max_total_tmp_space_usage=@save_max_total_tmp_space_usage;
set @@max_tmp_space_usage=0;
connection default;
insert into t1 (a,v) values(9999990,0);
commit;
select count(*) from t1;
count(*)
3001
disconnect c1;
drop table t1,t2;
#
# Test case from Elena
#
SET @@max_tmp_space_usage= 64*1024;
set @@binlog_format="statement";
CREATE OR REPLACE TABLE t1 (a INT, b INT);
select benchmark(1,1);
benchmark(1,1)
0
INSERT INTO t1 SELECT seq, seq FROM seq_1_to_100000;
ALTER TABLE t1 ORDER BY a, b;
ERROR HY000: Local temporary space limit reached
DROP TABLE t1;
